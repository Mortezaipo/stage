<!doctype html><html><head><title>Python Ldap Get Modified Users</title><link rel=stylesheet href=/css/bootstrap.min.css><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/css/fontawesome.min.css><link rel=stylesheet href=/css/syntax.css><script async src="https://www.googletagmanager.com/gtag/js?id=G-DPJYQNN1X6"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){window.dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-DPJYQNN1X6')</script></head><body><div class=top-banner><div class=container><div class="text-center site-title">ZeroToOne</div><div class=row><div class="col-md-6 offset-md-4"><ul class=nav><li class=nav-item><a class="nav-link fw-bold" title="home page" href=https://0t1.me/>HOME</a></li><li class=nav-item><a class="nav-link fw-bold" title=resume href=https://github.com/mortymacs/resume/releases/download/latest/resume.pdf target=_blank>RESUME</a></li><li class=nav-item><a class="nav-link fw-bold" title=contact href=mailto:m@0t1.me>CONTACT</a></li><li class=nav-item><a class=nav-link title=github href=https://github.com/mortymacs target=_blank><i class="fab fa-github"></i></a></li><li class=nav-item><a class=nav-link title=pypi href=https://pypi.org/user/mortymacs/ target=_blank><i class="fab fa-python"></i></a></li><li class=nav-item><a class=nav-link title=twitter href=https://twitter.com/mortymacs target=_blank><i class="fab fa-twitter"></i></a></li></ul></div></div></div></div><div id=content class=container><div class="row mt-2"><div><small class="post-publish-at fst-italic">Saturday, Nov 11, 2017</small>
<label class="badge post-tag">#tools</label>
<label class="badge post-tag">#python</label>
<label class="badge post-tag">#ldap</label>
<label class="badge post-tag">#server</label>
<label class="badge post-tag">#service</label>
<label class="badge post-tag">#linux</label></div><div><h2 class=post-title>Python Ldap Get Modified Users</h2><p class=post-body><p>In many systems when you want to implement an integration with LDAP services, normally you get all users details in every sync action which sometimes this amount of size is large and it&rsquo;s not good action to sync all users on every sync action.</p><p>To handle this situation we could implement several ways to increase sync performance and avoid duplicate or get already synced user again.</p><p>To handle this issue, you need to get openldap internal fields by adding a <code>+</code> sign at the end of search query like so:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>$ ldapsearch -h localhost -w <span class=s1>&#39;admin&#39;</span> -x -D <span class=s2>&#34;cn=admin,dc=example,dc=org&#34;</span> -b <span class=s2>&#34;DC=example,DC=org&#34;</span> +
</code></pre></div><p>And in python code it would like this:</p><div class=highlight><pre class=chroma><code class=language-python data-lang=python><span class=n>r</span> <span class=o>=</span> <span class=n>l</span><span class=o>.</span><span class=n>search_ext</span><span class=p>(</span><span class=s2>&#34;dc=example,dc=org&#34;</span><span class=p>,</span> <span class=n>ldap</span><span class=o>.</span><span class=n>SCOPE_SUBTREE</span><span class=p>,</span> <span class=s2>&#34;objectClass=*&#34;</span><span class=p>,</span> <span class=p>[</span><span class=s2>&#34;+&#34;</span><span class=p>,],</span> <span class=mi>0</span><span class=p>)</span>
</code></pre></div><p>Then it returns internal fields which are important like <code>modifyTimestamp</code>.</p><p>Or if you want to get all internal fields and user attributes in one request, just add <code>'*' '+'</code> like this:</p><div class=highlight><pre class=chroma><code class=language-python data-lang=python><span class=n>r</span> <span class=o>=</span> <span class=n>l</span><span class=o>.</span><span class=n>search_ext</span><span class=p>(</span><span class=s2>&#34;dc=example,dc=org&#34;</span><span class=p>,</span> <span class=n>ldap</span><span class=o>.</span><span class=n>SCOPE_SUBTREE</span><span class=p>,</span> <span class=s2>&#34;objectClass=*&#34;</span><span class=p>,</span> <span class=p>[</span><span class=s2>&#34;*&#34;</span><span class=p>,</span> <span class=s2>&#34;+&#34;</span><span class=p>],</span> <span class=mi>0</span><span class=p>)</span>
</code></pre></div><p>If you want to get last changed user after a specific date, try to add <code>modifyTimestamp</code> on query like this:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>$ ldapsearch -h localhost -w <span class=s1>&#39;admin&#39;</span> -x -D <span class=s2>&#34;cn=admin,dc=example,dc=org&#34;</span> -b <span class=s2>&#34;DC=example,DC=org&#34;</span> <span class=s2>&#34;modifyTimestamp&gt;=20171012152507Z
</span></code></pre></div><p>To get more info about history, try to enable <code>overlay accesslog</code> in your ldap and use it:</p><div class=highlight><pre class=chroma><code class=language-shell data-lang=shell>ldapsearch -x -b <span class=nv>cn</span><span class=o>=</span>accesslog
</code></pre></div></p><h5>References:</h5><ul><li>Active directory `whenChanged` field: <a href="https://msdn.microsoft.com/en-us/library/ms680921(v=vs.85).aspx" target=_blank>Microsoft MSDN doc</a></li><li>Open ldap `modifyTimestamp` field: <a href=https://tools.ietf.org/html/rfc4512 target=_blank>RFC4512</a></li><li>Open ldap all default attributes: <a href=http://www.phpldaptools.com/reference/Default-Schema-Attributes/ target=_blank>LDAP default schema attributes</a></li><li>Active Directory all default attributes: <a href="https://msdn.microsoft.com/en-us/library/ms675090(v=vs.85).aspx" target=_blank>Active Directory default schema attributes</a></li><li><a href=https://www.ibm.com/support/knowledgecenter/en/SSKTMJ_9.0.1/admin/conf_usingldapsearchtoreturnoperationalattributes_t.html target=_blank>ldapsearch to return operational attributes</a></li><li>Internal attributs: <a href=https://mail.python.org/pipermail/python-ldap/2009q3/002593.html target=_blank>Internal attributes (Python org mail)</a></li><li><a href=https://mail.python.org/pipermail/python-ldap/2009q3/002594.html target=_blank>Internal attributes (conversation node on Python org mail)</a></li><li>Access log: <a href=http://www.openldap.org/doc/admin24/overlays.html#Access%20Logging target=_blank>OpenLDAP access logging</a></li><li>How to check the login history of users on openldap: <a href=https://www.openldap.org/lists/openldap-technical/201505/msg00117.html target=_blank>OpenLDAP login history of users</a></li></ul></div></div><hr><div>All rights reserved by Morteza NourelahiAlamdari (mortymacs) &copy;<br>All contents are under the <a href=https://creativecommons.org/licenses/by-sa/4.0/ target=_blank>Attribution-ShareAlike 4.0 International (CC BY-SA 4.0)</a> license.<br>Top banner picture by <a href=https://unsplash.com/ target=_blank>Unsplash</a>.</div></div></body></html>